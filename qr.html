<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدخال الشحنات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f3f4f6; padding: 1rem; }
        .scanner-container { 
            position: relative; 
            max-width: 600px; 
            margin: auto; 
            height: 300px; 
        }
        #videoElement { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 40%;
            border: 3px solid var(--success-color);
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
            animation: scan-animation 2s infinite;
            clip-path: inset(0 0 0 0);
        }
        .controls {
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .scanning { 
            opacity: 0.5; 
        }
        .progress-bar {
            font-weight: bold;
            font-size: 1.1em;
            color: black; /* لون النص أسود */
            white-space: nowrap; /* منع النص من الانتقال لسطر جديد */
            position: relative; /* لجعل النص يظهر فوق الخلفية */
            z-index: 1; /* التأكد من ظهور النص */
        }
        @keyframes scan-animation {
            0% { opacity: 0.9; }
            50% { opacity: 0.4; }
            100% { opacity: 0.9; }
        }
    </style>
</head>
<body class="container mt-4">
    <h2 class="text-center text-primary">📦 إدخال الشحنات</h2>
    
    <div class="mb-3">
        <label for="vehicleSelect" class="form-label">اختر المركبة</label>
        <select id="vehicleSelect" class="form-select">
            <option value="2000">مركبة 1 - الحمولة 2 طن</option>
            <option value="10000">مركبة 2 - الحمولة 10 طن</option>
        </select>
    </div>
    
    <!-- الجدول هنا -->
    <table class="table mt-4">
        <thead>
            <tr>
                <th>الباركود</th>
                <th>الوزن (كجم)</th>
                <th>إزالة</th>
            </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
    </table>
    
    <!-- الوزن الإجمالي هنا -->
    <div class="mb-3">
        <label class="form-label">الوزن الكلي (كجم)</label>
        <div class="progress" style="height: 40px;">
            <div id="totalWeightProgress" 
                 class="progress-bar progress-bar-striped" 
                 role="progressbar" 
                 style="width: 0%; transition: width 0.3s ease, background-color 0.3s ease;"
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100">0/0 كجم
            </div>
        </div>
    </div>
    
    <!-- الأزرار هنا -->
    <div class="controls d-flex justify-content-center mt-3">
        <button class="btn btn-primary" id="toggleScan">بدء المسح</button>
        <button class="btn btn-secondary" id="switchCamera">تبديل الكاميرا</button>
        <button class="btn btn-warning" id="toggleFlash">🔦 الفلاش</button>
    </div>
    
    <!-- الكاميرا هنا -->
    <div class="scanner-container mt-3">
        <video id="videoElement" playsinline autoplay></video>
        <div class="scan-overlay"></div>
    </div>
    
    <!-- زر حفظ البيانات -->
    <button class="btn btn-success w-100 mt-3" id="saveData">حفظ البيانات</button>
    
    <script>
        const video = document.getElementById('videoElement');
        const startScan = document.getElementById('toggleScan');
        const switchCameraBtn = document.getElementById('switchCamera');
        const toggleFlashBtn = document.getElementById('toggleFlash');
        const shipmentTable = document.getElementById('shipmentTable');
        const totalWeightProgress = document.getElementById('totalWeightProgress');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const saveDataButton = document.getElementById('saveData');
        let currentWeight = 0;
        let maxWeight = parseInt(vehicleSelect.value);
        let scannedBarcodes = new Set();
        let isScanning = false;
        let isFlashOn = false;
        let currentCamera = 'environment';
        let mediaStream = null;
        let barcodeDetector;

        // حساب الوزن الكلي من الجدول
        const calculateTotalWeightFromTable = () => {
            let total = 0;
            shipmentTable.querySelectorAll('tr').forEach(row => {
                total += parseInt(row.cells[1].textContent);
            });
            return total;
        };

        // تحميل البيانات من localStorage عند تحميل الصفحة
        const loadDataFromLocalStorage = () => {
            const data = JSON.parse(localStorage.getItem('shipmentData'));
            if (data) {
                scannedBarcodes = new Set(data.scannedBarcodes);
                currentWeight = calculateTotalWeightFromTable();
                data.shipments.forEach(shipment => {
                    insertShipment(shipment.barcode, shipment.weight);
                });
                updateTotalWeight();
            }
        };

        // حفظ البيانات في localStorage
        const saveDataToLocalStorage = () => {
            const data = {
                scannedBarcodes: Array.from(scannedBarcodes),
                currentWeight,
                shipments: Array.from(shipmentTable.querySelectorAll('tr')).map(row => ({
                    barcode: row.cells[0].textContent,
                    weight: parseInt(row.cells[1].textContent)
                }))
            };
            localStorage.setItem('shipmentData', JSON.stringify(data));
        };

        // تحديث الوزن الكلي وشريط التقدم
        const updateTotalWeight = () => {
            currentWeight = calculateTotalWeightFromTable(); // تحديث الوزن من الجدول
            const percentage = Math.min((currentWeight / maxWeight) * 100, 100);
            totalWeightProgress.style.width = `${percentage}%`;
            totalWeightProgress.textContent = `${currentWeight}/${maxWeight} كجم`;
            
            // تغيير الألوان حسب النسبة
            if (percentage >= 90) {
                totalWeightProgress.classList.remove('bg-success', 'bg-warning');
                totalWeightProgress.classList.add('bg-danger');
            } else if (percentage >= 70) {
                totalWeightProgress.classList.remove('bg-success', 'bg-danger');
                totalWeightProgress.classList.add('bg-warning');
            } else {
                totalWeightProgress.classList.remove('bg-warning', 'bg-danger');
                totalWeightProgress.classList.add('bg-success');
            }
        };

        // إضافة شحنة جديدة
        const insertShipment = (barcode, weight) => {
            scannedBarcodes.add(barcode);
            const row = document.createElement('tr');
            row.id = `shipment-${barcode}`;
            row.innerHTML = `<td>${barcode}</td><td>${weight}</td><td><button class="btn btn-danger btn-sm" onclick="removeShipment(this, ${weight}, '${barcode}')">❌</button></td>`;
            shipmentTable.appendChild(row);
            updateTotalWeight(); // تحديث الوزن الكلي بعد الإضافة
            saveDataToLocalStorage();
        };

        // إزالة شحنة
        const removeShipment = (button, weight, barcode) => {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حذف الشحنة نهائيًا.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    scannedBarcodes.delete(barcode);
                    button.closest('tr').remove();
                    updateTotalWeight(); // تحديث الوزن الكلي بعد الإزالة
                    saveDataToLocalStorage();
                }
            });
        };

        // تحذير عند تغيير المركبة
        const warnBeforeChangingVehicle = () => {
            if (shipmentTable.rows.length > 0) {
                Swal.fire({
                    title: 'تحذير!',
                    text: 'سيتم حذف جميع البيانات الحالية. هل أنت متأكد؟',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم',
                    cancelButtonText: 'إلغاء'
                }).then((result) => {
                    if (result.isConfirmed) {
                        clearData(); // حذف البيانات
                        maxWeight = parseInt(vehicleSelect.value); // تحديث الحد الأقصى
                        updateTotalWeight();
                    } else {
                        vehicleSelect.value = maxWeight; // إعادة تعيين القيمة السابقة
                    }
                });
            } else {
                maxWeight = parseInt(vehicleSelect.value);
                updateTotalWeight();
            }
        };

        // تفريغ الجدول والبيانات المحفوظة
        const clearData = () => {
            shipmentTable.innerHTML = ''; // تفريغ الجدول
            currentWeight = 0; // إعادة تعيين الوزن الإجمالي
            updateTotalWeight();
            scannedBarcodes.clear(); // تفريغ الباركود الممسوحة
            localStorage.removeItem('shipmentData'); // حذف البيانات المحفوظة
        };

        // تحميل الصفحة
        window.onload = async () => {
            const hasPermission = await checkCameraPermissions();
            if (hasPermission) {
                await initializeBarcodeDetector();
            }
            loadDataFromLocalStorage();
        };

        // الأحداث
        startScan.addEventListener('click', async () => {
            if (!isScanning) {
                await startCamera();
                startScan.textContent = 'إيقاف المسح';
            } else {
                stopCamera();
                startScan.textContent = 'بدء المسح';
            }
        });

        switchCameraBtn.addEventListener('click', switchCamera);
        toggleFlashBtn.addEventListener('click', toggleFlash);

        vehicleSelect.addEventListener('change', warnBeforeChangingVehicle);

        saveDataButton.addEventListener('click', () => {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حفظ البيانات وحذفها من الشاشة.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveDataToLocalStorage();
                    clearData(); // تفريغ الجدول والبيانات المحفوظة
                    Swal.fire('تم الحفظ!', 'تم حفظ البيانات بنجاح.', 'success');
                }
            });
        });
    </script>
</body>
</html>
