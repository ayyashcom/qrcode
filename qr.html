<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: #f3f4f6;
            padding: 1rem;
        }

        .scanner-container {
            position: relative;
            max-width: 800px;
            margin: 2rem auto;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        #videoElement {
            width: 100%;
            height: auto;
            transform: scaleX(-1);
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 30%;
            border: 3px solid #10b981;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
            animation: scan-animation 2s infinite;
        }

        .controls {
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .fab-btn {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 999;
        }

        #totalWeight {
            background-color: #f1f1f1;
            font-weight: bold;
        }

        #shipmentTable .btn-danger {
            font-size: 1.1rem;
        }
        
        .alert-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        @keyframes scan-animation {
            0% { opacity: 0.9; }
            50% { opacity: 0.4; }
            100% { opacity: 0.9; }
        }
    </style>
</head>
<body class="container mt-4">
    <h2 class="text-center text-primary">ğŸ“¦ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</h2>

    <div class="mb-3">
        <label for="vehicleSelect" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <select id="vehicleSelect" class="form-select">
            <option value="2000">Ù…Ø±ÙƒØ¨Ø© 1 - Ø§Ù„Ø­Ù…ÙˆÙ„Ø© 2 Ø·Ù†</option>
            <option value="10000">Ù…Ø±ÙƒØ¨Ø© 2 - Ø§Ù„Ø­Ù…ÙˆÙ„Ø© 10 Ø·Ù†</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ (ÙƒØ¬Ù…)</label>
        <input type="text" id="totalWeight" class="form-control" readonly value="0">
    </div>

    <div class="scanner-container">
        <video id="videoElement" playsinline autoplay></video>
        <div class="scan-overlay"></div>
    </div>

    <button class="btn btn-primary w-100 mt-3" id="startScan">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</button>

    <table class="table mt-4">
        <thead>
            <tr>
                <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</th>
                <th>Ø¥Ø²Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
    </table>

    <div class="fab-btn">
        <button class="btn btn-success" id="startScan">ğŸ“·</button>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const startScan = document.getElementById('startScan');
        const shipmentTable = document.getElementById('shipmentTable');
        const totalWeightField = document.getElementById('totalWeight');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const scanOverlay = document.querySelector('.scan-overlay');
        let currentWeight = 0;
        let maxWeight = parseInt(vehicleSelect.value);
        let scannedBarcodes = new Set();
        let mediaStream = null;
        let isScanning = false;

        vehicleSelect.addEventListener('change', () => {
            maxWeight = parseInt(vehicleSelect.value);
            updateTotalWeight();
        });

        const startCamera = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            mediaStream = stream;
        };

        const detectBarcode = () => {
            setTimeout(() => {
                const fakeBarcode = Math.floor(Math.random() * 1000000); // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨ÙƒØ§Ø´Ù Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ¹Ù„ÙŠ
                handleScannedBarcode(fakeBarcode.toString());
            }, 2000);
        };

        const handleScannedBarcode = (barcode) => {
            if (scannedBarcodes.has(barcode)) {
                Swal.fire({
                    title: 'ØªÙ†Ø¨ÙŠÙ‡!',
                    text: 'ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) addShipment(barcode);
                });
            } else {
                addShipment(barcode);
            }
        };

        const addShipment = (barcode) => {
            const shipmentWeight = 50;
            if (currentWeight + shipmentWeight > maxWeight) {
                Swal.fire({
                    title: 'Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ù…ØªÙ„Ø¦Ø©!',
                    text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŸ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù…ØªØ§Ø¨Ø¹Ø©',
                    cancelButtonText: 'Ø¥Ù†Ù‡Ø§Ø¡'
                }).then((result) => {
                    if (!result.isConfirmed) return;
                    insertShipment(barcode, shipmentWeight);
                });
            } else if (currentWeight + shipmentWeight >= maxWeight * 0.9) {
                Swal.fire({
                    title: 'ØªÙ†Ø¨ÙŠÙ‡!',
                    text: `Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„Ø§Ù…ØªÙ„Ø§Ø¡ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ${(maxWeight - currentWeight - shipmentWeight)} ÙƒØ¬Ù…`,
                    icon: 'warning'
                });
                insertShipment(barcode, shipmentWeight);
            } else {
                insertShipment(barcode, shipmentWeight);
            }
        };

        const insertShipment = (barcode, weight) => {
            scannedBarcodes.add(barcode);
            currentWeight += weight;
            updateTotalWeight();
            
            const row = document.createElement('tr');
            row.innerHTML = `<td>${barcode}</td><td>${weight}</td><td><button class="btn btn-danger btn-sm" onclick="removeShipment(this, ${weight}, '${barcode}')">âŒ</button></td>`;
            shipmentTable.appendChild(row);
        };

        const removeShipment = (button, weight, barcode) => {
            Swal.fire({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
                text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    scannedBarcodes.delete(barcode);
                    currentWeight -= weight;
                    updateTotalWeight();
                    button.closest('tr').remove();
                }
            });
        };

        const updateTotalWeight = () => {
            totalWeightField.value = currentWeight;
        };

        const saveData = () => {
            localStorage.setItem('scannedBarcodes', JSON.stringify(Array.from(scannedBarcodes)));
            localStorage.setItem('currentWeight', currentWeight);
        };

        window.addEventListener('load', () => {
            const savedBarcodes = JSON.parse(localStorage.getItem('scannedBarcodes')) || [];
            const savedWeight = localStorage.getItem('currentWeight') || 0;
            scannedBarcodes = new Set(savedBarcodes);
            currentWeight = parseInt(savedWeight);

            savedBarcodes.forEach(barcode => {
                addShipment(barcode);
            });
        });

        startScan.addEventListener('click', () => {
            if (isScanning) {
                stopCamera();
            } else {
                startCamera();
                detectBarcode();
                isScanning = true;
            }
        });

        const stopCamera = () => {
            mediaStream.getTracks().forEach(track => track.stop());
            isScanning = false;
            detectBarcode(); // ÙŠØ¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        };

        document.querySelector('#startScan').addEventListener('click', startScan);
    </script>
</body>
</html>
