<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f3f4f6; padding: 1rem; }
        .scanner-container { 
            position: relative; 
            max-width: 600px; 
            margin: auto; 
            height: 300px; 
        }
        #videoElement { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 40%;
            border: 3px solid var(--success-color);
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
            animation: scan-animation 2s infinite;
            clip-path: inset(0 0 0 0);
        }
        .controls {
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .scanning { 
            opacity: 0.5; 
        }
        .progress-bar {
            font-weight: bold;
            font-size: 1.1em;
            color: black;
            white-space: nowrap;
            position: relative;
            z-index: 1;
        }
        @keyframes scan-animation {
            0% { opacity: 0.9; }
            50% { opacity: 0.4; }
            100% { opacity: 0.9; }
        }
    </style>
</head>
<body class="container mt-4">
    <h2 class="text-center text-primary">ğŸ“¦ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</h2>
    
    <div class="mb-3">
        <label for="vehicleSelect" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <select id="vehicleSelect" class="form-select">
            <option value="2000">Ù…Ø±ÙƒØ¨Ø© 1 - Ø§Ù„Ø­Ù…ÙˆÙ„Ø© 2 Ø·Ù†</option>
            <option value="10000">Ù…Ø±ÙƒØ¨Ø© 2 - Ø§Ù„Ø­Ù…ÙˆÙ„Ø© 10 Ø·Ù†</option>
        </select>
    </div>
    
    <table class="table mt-4">
        <thead>
            <tr>
                <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</th>
                <th>Ø¥Ø²Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
    </table>
    
    <div class="mb-3">
        <label class="form-label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ (ÙƒØ¬Ù…)</label>
        <div class="progress" style="height: 40px;">
            <div id="totalWeightProgress" 
                 class="progress-bar progress-bar-striped" 
                 role="progressbar" 
                 style="width: 0%; transition: width 0.3s ease, background-color 0.3s ease;"
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100">0/0 ÙƒØ¬Ù…
            </div>
        </div>
    </div>
    
    <div class="controls d-flex justify-content-center mt-3">
        <button class="btn btn-primary" id="toggleScan">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</button>
        <button class="btn btn-secondary" id="switchCamera">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="btn btn-warning" id="toggleFlash">ğŸ”¦ Ø§Ù„ÙÙ„Ø§Ø´</button>
    </div>
    
    <div class="scanner-container mt-3">
        <video id="videoElement" playsinline autoplay></video>
        <div class="scan-overlay"></div>
    </div>
    
    <button class="btn btn-success w-100 mt-3" id="saveData">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    
    <script>
        const video = document.getElementById('videoElement');
        const startScan = document.getElementById('toggleScan');
        const switchCameraBtn = document.getElementById('switchCamera');
        const toggleFlashBtn = document.getElementById('toggleFlash');
        const shipmentTable = document.getElementById('shipmentTable');
        const totalWeightProgress = document.getElementById('totalWeightProgress');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const saveDataButton = document.getElementById('saveData');
        let currentWeight = 0;
        let maxWeight = parseInt(vehicleSelect.value);
        let scannedBarcodes = new Set();
        let isScanning = false;
        let isFlashOn = false;
        let currentCamera = 'environment';
        let mediaStream = null;
        let barcodeDetector;

        // ØªÙ‡ÙŠØ¦Ø© ÙƒØ§Ø´Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const initializeBarcodeDetector = async () => {
            if ('BarcodeDetector' in window) {
                try {
                    await BarcodeDetector.getSupportedFormats();
                    barcodeDetector = new BarcodeDetector({ formats: ['code_128', 'ean_13'] });
                    return true;
                } catch (error) {
                    Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯', 'error');
                    return false;
                }
            } else {
                Swal.fire('Ø®Ø·Ø£', 'ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø­Ø¯ÙŠØ« Ù…Ø«Ù„ Chrome 84+', 'error');
                return false;
            }
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const startCamera = async () => {
            try {
                const constraints = { 
                    video: { 
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        torch: isFlashOn 
                    } 
                };
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = mediaStream;
                video.style.transform = currentCamera === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
                startScanning();
            } catch (error) {
                handleError(error);
            }
        };

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const stopCamera = () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            isScanning = false;
            document.querySelector('.scan-overlay').classList.remove('scanning');
            startScan.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­';
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­
        const startScanning = () => {
            isScanning = true;
            document.querySelector('.scan-overlay').classList.add('scanning');
            detectBarcode();
        };

        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const detectBarcode = async () => {
            if (!isScanning) return;
            try {
                const barcodes = await barcodeDetector.detect(video);
                if (barcodes.length > 0) {
                    handleDetectedBarcode(barcodes[0].rawValue);
                    return;
                }
                requestAnimationFrame(detectBarcode);
            } catch (error) {
                requestAnimationFrame(detectBarcode);
            }
        };

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´
        const toggleFlash = async () => {
            if (!mediaStream) return;
            const track = mediaStream.getVideoTracks()[0];
            if (track.getCapabilities().torch) {
                isFlashOn = !isFlashOn;
                await track.applyConstraints({ advanced: [{ torch: isFlashOn }] });
                toggleFlashBtn.textContent = isFlashOn ? 'Ø¥Ø·ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§Ø´' : 'ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´';
            } else {
                Swal.fire('ØªØ­Ø°ÙŠØ±', 'Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'warning');
            }
        };

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const switchCamera = async () => {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            stopCamera();
            await startCamera();
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = async () => {
            const hasPermission = await checkCameraPermissions();
            if (hasPermission && await initializeBarcodeDetector()) {
                loadDataFromLocalStorage();
            }
        };

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (handleDetectedBarcode, insertShipment, updateTotalWeight, ...) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ
        // ... [Ø§Ø¨Ù‚Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø³Ù„Ø§Ù…ØªÙ‡Ø§] ...
    </script>
</body>
</html>
