<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù…Ø±Ùˆ Ù†Ø³Ø®Ù‡ 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --overlay-color: rgba(0, 0, 0, 0.7);
        }

        body {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 1rem;
        }

        .scanner-wrapper {
            position: relative;
            max-width: 800px;
            margin: 1rem auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        #preview {
            width: 100%;
            height: 60vh;
            object-fit: cover;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 30%;
            border: 3px solid #10b981;
            box-shadow: 0 0 0 100vmax var(--overlay-color);
        }

        #resultContainer {
            max-width: 800px;
            margin: 1rem auto;
            display: none;
        }
    </style>
</head>
<body class="d-flex flex-column align-items-center">
    <h1 class="text-primary mb-3">ğŸ” Ù‚Ø§Ø±Ø¦ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø¦Ù‚ Ø§Ù„Ø³Ø±Ø¹Ø©</h1>
    
    <div class="scanner-wrapper">
        <video id="preview" playsinline></video>
        <div class="scan-overlay"></div>
    </div>

    <div id="resultContainer" class="card w-100">
        <div class="card-body">
            <h5 class="card-title">Ø§Ù„Ù†ØªÙŠØ¬Ø©:</h5>
            <pre id="scanResult" class="bg-light p-3 rounded"></pre>
            <button onclick="restartScan()" class="btn btn-primary">Ù…Ø³Ø­ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <div class="controls mt-3">
        <button id="startBtn" class="btn btn-success btn-lg">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­</button>
        <button id="flipBtn" class="btn btn-secondary btn-lg">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>

    <script>
        const codeReader = new ZXing.BrowserMultiFormatReader();
        let currentDeviceId = '';
        let isScanning = false;
        let mediaStream = null;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
        async function initScanner() {
            try {
                // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø£ÙˆÙ„Ø§Ù‹
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                tempStream.getTracks().forEach(track => track.stop());
                
                const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
                const backCamera = devices.find(d => d.label.toLowerCase().includes('back'));
                currentDeviceId = backCamera?.deviceId || devices[0]?.deviceId;
                
                if (!currentDeviceId) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§');
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('flipBtn').hidden = devices.length < 2;
            } catch (error) {
                showError('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…', error.message);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­
        async function startScan() {
            try {
                if (isScanning) return;
                
                showLoading(true);
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        deviceId: currentDeviceId,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }
                });

                document.getElementById('preview').srcObject = mediaStream;
                await new Promise(resolve => document.getElementById('preview').onplaying = resolve);
                
                codeReader.decodeFromVideoDevice(currentDeviceId, 'preview', (result, err) => {
                    if (result) handleSuccess(result.text);
                    if (err && !(err instanceof ZXing.NotFoundException)) console.error(err);
                });

                isScanning = true;
                showLoading(false);
            } catch (error) {
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§', error.message);
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        function handleSuccess(result) {
            stopCamera();
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('scanResult').textContent = result;
            document.getElementById('startBtn').textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„';
            isScanning = false;
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            codeReader.reset();
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function flipCamera() {
            const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
            const currentIndex = devices.findIndex(d => d.deviceId === currentDeviceId);
            currentDeviceId = devices[(currentIndex + 1) % devices.length].deviceId;
            if (isScanning) {
                stopCamera();
                startScan();
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
        function restartScan() {
            document.getElementById('resultContainer').style.display = 'none';
            startScan();
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        function showError(title, message) {
            Swal.fire({
                title: title,
                text: message,
                icon: 'error',
                confirmButtonText: 'Ø­Ø³Ù†Ù‹Ø§'
            });
            document.getElementById('startBtn').disabled = true;
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø±
        document.getElementById('startBtn').addEventListener('click', () => {
            isScanning ? restartScan() : startScan();
        });

        document.getElementById('flipBtn').addEventListener('click', flipCamera);

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        window.onload = initScanner;
    </script>
</body>
</html>