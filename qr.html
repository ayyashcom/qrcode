<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدخال الشحنات باستخدام كاميرا</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f3f4f6; padding: 1rem; }
        .scanner-container { position: relative; max-width: 800px; margin: auto; }
        #videoElement { width: 100%; height: auto; transform: scaleX(-1); }
        .scan-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 30%; border: 3px solid #10b981; box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7); animation: scan-animation 2s infinite; }
        @keyframes scan-animation { 0% { opacity: 0.9; } 50% { opacity: 0.4; } 100% { opacity: 0.9; } }
    </style>
</head>
<body class="container mt-4">
    <h2 class="text-center text-primary">📦 إدخال الشحنات</h2>
    
    <div class="mb-3">
        <label for="vehicleSelect" class="form-label">اختر المركبة</label>
        <select id="vehicleSelect" class="form-select">
            <option value="2000">مركبة 1 - الحمولة 2 طن</option>
            <option value="10000">مركبة 2 - الحمولة 10 طن</option>
        </select>
    </div>
    
    <div class="mb-3">
        <label class="form-label">الوزن الكلي (كجم)</label>
        <input type="text" id="totalWeight" class="form-control" readonly value="0">
    </div>
    
    <div class="scanner-container">
        <video id="videoElement" playsinline autoplay></video>
        <div class="scan-overlay"></div>
    </div>
    
    <button class="btn btn-primary w-100 mt-3" id="startScan">بدء المسح</button>
    
    <table class="table mt-4">
        <thead>
            <tr>
                <th>الباركود</th>
                <th>الوزن (كجم)</th>
                <th>إزالة</th>
            </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
    </table>
    
    <script>
        const video = document.getElementById('videoElement');
        const startScan = document.getElementById('startScan');
        const shipmentTable = document.getElementById('shipmentTable');
        const totalWeightField = document.getElementById('totalWeight');
        const vehicleSelect = document.getElementById('vehicleSelect');
        let currentWeight = 0;
        let maxWeight = parseInt(vehicleSelect.value);
        let scannedBarcodes = new Set();
        let mediaStream = null;
        let isScanning = false;
        let barcodeDetector;

        vehicleSelect.addEventListener('change', () => {
            maxWeight = parseInt(vehicleSelect.value);
            updateTotalWeight();
        });

        const initializeBarcodeDetector = async () => {
            if ('BarcodeDetector' in window) {
                barcodeDetector = new BarcodeDetector({ formats: ['qr_code', 'code_128', 'ean_13'] });
            } else {
                Swal.fire('خطأ', 'يرجى استخدام متصفح حديث مثل Chrome 84+', 'error');
            }
        };

        const startCamera = async () => {
            const constraints = {
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
            };
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = mediaStream;
            startScanning();
        };

        const startScanning = () => {
            isScanning = true;
            detectBarcode();
        };

        const detectBarcode = async () => {
            if (!isScanning) return;

            try {
                const barcodes = await barcodeDetector.detect(video);
                
                if (barcodes.length > 0) {
                    handleScannedBarcode(barcodes[0].rawValue);
                } else {
                    requestAnimationFrame(detectBarcode);
                }
            } catch (error) {
                console.error('خطأ في الكشف:', error);
                requestAnimationFrame(detectBarcode);
            }
        };

        const handleScannedBarcode = (barcode) => {
            if (scannedBarcodes.has(barcode)) {
                Swal.fire({
                    title: 'تنبيه!',
                    text: 'تم إدخال هذا الباركود مسبقًا. هل تريد إضافته مرة أخرى؟',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم',
                    cancelButtonText: 'إلغاء'
                }).then((result) => {
                    if (result.isConfirmed) addShipment(barcode);
                });
            } else {
                addShipment(barcode);
            }
        };

        const addShipment = (barcode) => {
            const shipmentWeight = 50;
            if (currentWeight + shipmentWeight > maxWeight) {
                Swal.fire({
                    title: 'المركبة ممتلئة!',
                    text: 'هل تريد إنهاء الإضافة أم متابعة التحميل؟',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'متابعة',
                    cancelButtonText: 'إنهاء'
                }).then((result) => {
                    if (!result.isConfirmed) return;
                    insertShipment(barcode, shipmentWeight);
                });
            } else {
                insertShipment(barcode, shipmentWeight);
            }
        };

        const insertShipment = (barcode, weight) => {
            scannedBarcodes.add(barcode);
            currentWeight += weight;
            updateTotalWeight();

            const row = document.createElement('tr');
            row.innerHTML = `<td>${barcode}</td><td>${weight}</td><td><button class="btn btn-danger btn-sm" onclick="removeShipment(this, ${weight}, '${barcode}')">❌</button></td>`;
            shipmentTable.appendChild(row);
        };

        const removeShipment = (button, weight, barcode) => {
            scannedBarcodes.delete(barcode);
            currentWeight -= weight;
            updateTotalWeight();
            button.closest('tr').remove();
        };

        const updateTotalWeight = () => {
            totalWeightField.value = currentWeight;
        };

        const stopCamera = () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            isScanning = false;
            document.getElementById('startScan').textContent = 'بدء المسح';
        };

        startScan.addEventListener('click', () => {
            if (!isScanning) {
                startCamera();
                document.getElementById('startScan').textContent = 'إيقاف المسح';
            } else {
                stopCamera();
            }
        });

        (async () => {
            await initializeBarcodeDetector();
        })();
    </script>
</body>
</html>
