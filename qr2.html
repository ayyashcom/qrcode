<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { background: #f3f4f6; padding: 1rem; }
        .scanner-container { 
            position: relative; 
            max-width: 600px; 
            margin: auto; 
            height: 300px; 
        }
        #videoElement { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 40%;
            border: 3px solid var(--bs-success);
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
            animation: scan-animation 2s infinite;
            clip-path: inset(0 0 0 0);
        }
        .controls {
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        .scanning { 
            opacity: 0.5; 
        }
        .progress-bar {
            font-weight: bold;
            font-size: 1.1em;
            color: black !important;
            text-shadow: 0 0 3px white;
            padding: 0 10px;
            white-space: nowrap;
        }
        @keyframes scan-animation {
            0% { opacity: 0.9; }
            50% { opacity: 0.4; }
            100% { opacity: 0.9; }
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.65;
        }
    </style>
</head>
<body class="container mt-4">
    <h2 class="text-center text-primary" aria-label="Ø¹Ù†ÙˆØ§Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª">ğŸ“¦ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</h2>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
    <div class="mb-3">
        <label for="vehicleSelect" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
        <select id="vehicleSelect" class="form-select" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©">
            <option value="2000">Ù…Ø±ÙƒØ¨Ø© 1 - Ø§Ù„Ø­Ù…ÙˆÙ„Ø© 2 Ø·Ù†</option>
            <option value="10000">Ù…Ø±ÙƒØ¨Ø© 2 - Ø§Ù„Ø­Ù…ÙˆÙ„Ø© 10 Ø·Ù†</option>
        </select>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª -->
    <table class="table mt-4" aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª">
        <thead>
            <tr>
                <th scope="col">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                <th scope="col">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</th>
                <th scope="col">Ø¥Ø²Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="shipmentTable"></tbody>
    </table>

    <!-- Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ -->
    <div class="mb-3">
        <label class="form-label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ (ÙƒØ¬Ù…)</label>
        <div class="progress" style="height: 40px;">
            <div id="totalWeightProgress" 
                 class="progress-bar progress-bar-striped bg-success" 
                 role="progressbar" 
                 style="width: 0%; transition: width 0.3s ease, background-color 0.3s ease;"
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100"> vors
            </div>
        </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="controls d-flex justify-content-center mt-3 flex-wrap">
        <button class="btn btn-primary m-1" id="toggleScan" aria-label="Ø¨Ø¯Ø¡ Ø£Ùˆ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­</button>
        <button class="btn btn-secondary m-1" id="switchCamera" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="btn btn-warning m-1" id="toggleFlash" aria-label="ØªØ´ØºÙŠÙ„ Ø£Ùˆ Ø¥Ø·ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§Ø´">ğŸ”¦ Ø§Ù„ÙÙ„Ø§Ø´</button>
        <button class="btn btn-info m-1" id="manualInput" aria-label="Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button>
    </div>

    <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div class="scanner-container mt-3">
        <video id="videoElement" playsinline autoplay muted></video>
        <div class="scan-overlay"></div>
    </div>

    <!-- Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <button class="btn btn-success w-100 mt-3" id="saveData" aria-label="Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        const video = document.getElementById('videoElement');
        const startScan = document.getElementById('toggleScan');
        const switchCameraBtn = document.getElementById('switchCamera');
        const toggleFlashBtn = document.getElementById('toggleFlash');
        const manualInputBtn = document.getElementById('manualInput');
        const shipmentTable = document.getElementById('shipmentTable');
        const totalWeightProgress = document.getElementById('totalWeightProgress');
        const vehicleSelect = document.getElementById('vehicleSelect');
        const saveDataButton = document.getElementById('saveData');
        let currentWeight = 0;
        let maxWeight = parseInt(vehicleSelect.value);
        let scannedBarcodes = new Set();
        let isScanning = false;
        let isFlashOn = false;
        let currentCamera = 'environment';
        let mediaStream = null;
        let barcodeDetector = null;
        let codeReader = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const isValidBarcode = (barcode) => {
            return /^[A-Za-z0-9-_]+$/.test(barcode); // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
        const loadDataFromLocalStorage = () => {
            const data = JSON.parse(localStorage.getItem('shipmentData'));
            if (data) {
                scannedBarcodes = new Set(data.scannedBarcodes);
                currentWeight = data.shipments.reduce((sum, shipment) => sum + shipment.weight, 0);
                data.shipments.forEach(shipment => {
                    insertShipment(shipment.barcode, shipment.weight, false);
                });
                updateTotalWeight();
                saveDataToLocalStorage();
            }
        };

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
        const saveDataToLocalStorage = () => {
            const data = {
                scannedBarcodes: Array.from(scannedBarcodes),
                currentWeight,
                shipments: Array.from(shipmentTable.querySelectorAll('tr')).map(row => ({
                    barcode: row.cells[0].textContent,
                    weight: parseFloat(row.cells[1].textContent)
                }))
            };
            localStorage.setItem('shipmentData', JSON.stringify(data));
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ²Ù† Ø§Ù„ÙƒÙ„ÙŠ
        const updateTotalWeight = () => {
            const percentage = Math.min((currentWeight / maxWeight) * 100, 100);
            totalWeightProgress.style.width = `${percentage}%`;
            totalWeightProgress.textContent = `${currentWeight}/${maxWeight} ÙƒØ¬Ù…`;
            totalWeightProgress.setAttribute('aria-valuenow', currentWeight);

            if (percentage >= 90) {
                totalWeightProgress.classList.remove('bg-success', 'bg-warning');
                totalWeightProgress.classList.add('bg-danger');
            } else if (percentage >= 70) {
                totalWeightProgress.classList.remove('bg-success', 'bg-danger');
                totalWeightProgress.classList.add('bg-warning');
            } else {
                totalWeightProgress.classList.remove('bg-warning', 'bg-danger');
                totalWeightProgress.classList.add('bg-success');
            }
        };

        // Ø¥Ø¶Ø§ÙØ© Ø´Ø­Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©
        const insertShipment = (barcode, weight, shouldSave = true) => {
            scannedBarcodes.add(barcode);
            currentWeight += weight;
            updateTotalWeight();
            const row = document.createElement('tr');
            row.id = `shipment-${barcode}`;
            row.innerHTML = `<td>${barcode}</td><td>${weight.toFixed(2)}</td><td><button class="btn btn-danger btn-sm" onclick="removeShipment(this, ${weight}, '${barcode}')" aria-label="Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø­Ù†Ø© ${barcode}">âŒ</button></td>`;
            shipmentTable.appendChild(row);
            if (shouldSave) saveDataToLocalStorage();
        };

        // Ø¥Ø²Ø§Ù„Ø© Ø´Ø­Ù†Ø©
        const removeShipment = (button, weight, barcode) => {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø­Ù†Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    scannedBarcodes.delete(barcode);
                    currentWeight -= weight;
                    updateTotalWeight();
                    button.closest('tr').remove();
                    saveDataToLocalStorage();
                }
            });
        };

        // Ø¥Ø¶Ø§ÙØ© Ø´Ø­Ù†Ø© Ù…Ø¹ ÙˆØ²Ù† ÙŠØ¯ÙˆÙŠ
        const addShipment = (barcode) => {
            if (!isValidBarcode(barcode)) {
                Swal.fire('Ø®Ø·Ø£', 'ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­.', 'error');
                return;
            }
            Swal.fire({
                title: 'Ø£Ø¯Ø®Ù„ ÙˆØ²Ù† Ø§Ù„Ø´Ø­Ù†Ø© (ÙƒØ¬Ù…)',
                input: 'number',
                inputAttributes: { min: 0, step: 0.1 },
                showCancelButton: true,
                confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                inputValidator: (value) => {
                    if (!value || value <= 0) {
                        return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ù† ØµØ§Ù„Ø­ Ø£ÙƒØ¨Ø± Ù…Ù† 0';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const shipmentWeight = parseFloat(result.value);
                    if (currentWeight + shipmentWeight > maxWeight) {
                        Swal.fire('Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ù…Ù…ØªÙ„Ø¦Ø©!', 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§.', 'warning');
                        return;
                    }
                    if (scannedBarcodes.has(barcode)) {
                        Swal.fire({
                            title: 'ØªØ­Ø°ÙŠØ±!',
                            text: 'Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø­Ù†Ø© Ù…Ø¶Ø§ÙØ© Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Ù†Ø¹Ù…',
                            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                insertShipment(barcode, shipmentWeight);
                            }
                        });
                        return;
                    }
                    insertShipment(barcode, shipmentWeight);
                }
            });
        };

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù…Ø³ÙˆØ­
        const handleDetectedBarcode = (data) => {
            Swal.fire({
                title: 'ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­!',
                html: `<div class="text-break p-3 bg-light rounded">${data}</div>`,
                icon: 'success',
                confirmButtonText: 'ØªÙ…'
            }).then(() => {
                stopCamera();
                addShipment(data);
            });
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const startCamera = async () => {
            try {
                const constraints = { 
                    video: { 
                        facingMode: currentCamera, 
                        width: { ideal: window.innerWidth <= 768 ? 640 : 1280 }, 
                        height: { ideal: window.innerWidth <= 768 ? 480 : 720 } 
                    } 
                };
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = mediaStream;
                video.style.transform = currentCamera === 'environment' ? 'scaleX(1)' : 'scaleX(-1)';
                startScanning();
            } catch (error) {
                handleError(error);
            }
        };

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­
        const startScanning = () => {
            isScanning = true;
            document.querySelector('.scan-overlay').classList.add('scanning');
            startScan.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­';
            startScan.disabled = true;
            setTimeout(() => { startScan.disabled = false; }, 1000);
            detectBarcode();
        };

        // Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const detectBarcode = async () => {
            if (!isScanning) return;

            try {
                if (barcodeDetector) {
                    const barcodes = await barcodeDetector.detect(video);
                    if (barcodes.length > 0) {
                        handleDetectedBarcode(barcodes[0].rawValue);
                        return;
                    }
                } else if (codeReader) {
                    codeReader.decodeFromVideoElement(video, (result, err) => {
                        if (result) {
                            handleDetectedBarcode(result.text);
                        } else if (err && !(err instanceof window.ZXing.NotFoundException)) {
                            handleError(err);
                        }
                    });
                }
                requestAnimationFrame(detectBarcode);
            } catch (error) {
                requestAnimationFrame(detectBarcode);
            }
        };

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const stopCamera = () => {
            if (mediaStream) {
                mediaStream.getVideoTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            isScanning = false;
            document.querySelector('.scan-overlay').classList.remove('scanning');
            startScan.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­';
        };

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const switchCamera = async () => {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            stopCamera();
            await startCamera();
        };

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´
        const toggleFlash = async () => {
            if (!mediaStream) return;
            const track = mediaStream.getVideoTracks()[0];
            if (track.getCapabilities().torch) {
                isFlashOn = !isFlashOn;
                await track.applyConstraints({ advanced: [{ torch: isFlashOn }] });
                toggleFlashBtn.textContent = isFlashOn ? 'Ø¥Ø·ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§Ø´' : 'ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´';
            } else {
                Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.', 'error');
            }
        };

        // Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ
        const manualInput = () => {
            Swal.fire({
                title: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§',
                input: 'text',
                showCancelButton: true,
                confirmButtonText: 'Ø¥Ø¶Ø§ÙØ©',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                inputValidator: (value) => {
                    if (!value || !isValidBarcode(value)) {
                        return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØµØ§Ù„Ø­';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    addShipment(result.value);
                }
            });
        };

        // ØªÙ‡ÙŠØ¦Ø© BarcodeDetector Ø£Ùˆ ZXing
        const initializeBarcodeDetector = async () => {
            if ('BarcodeDetector' in window) {
                barcodeDetector = new BarcodeDetector({ formats: ['qr_code', 'code_128', 'ean_13'] });
            } else {
                codeReader = new ZXing.BrowserMultiFormatReader();
                Swal.fire('ØªØ­Ø°ÙŠØ±', 'ÙˆØ§Ø¬Ù‡Ø© BarcodeDetector ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©. ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ZXing ÙƒØ¨Ø¯ÙŠÙ„.', 'warning');
            }
        };

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const checkCameraPermissions = async () => {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameraDevices = devices.filter(device => device.kind === 'videoinput');
                if (cameraDevices.length === 0) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§');
                return true;
            } catch (error) {
                handleError(error);
                return false;
            }
        };

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const handleError = (error) => {
            Swal.fire('Ø®Ø·Ø£', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
        };

        // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const clearData = () => {
            shipmentTable.innerHTML = '';
            currentWeight = 0;
            updateTotalWeight();
            scannedBarcodes.clear();
            localStorage.removeItem('shipmentData');
        };

        // ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
        const warnBeforeChangingVehicle = () => {
            if (shipmentTable.rows.length > 0) {
                Swal.fire({
                    title: 'ØªØ­Ø°ÙŠØ±!',
                    text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ù†Ø¹Ù…',
                    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
                }).then((result) => {
                    if (result.isConfirmed) {
                        clearData();
                        maxWeight = parseInt(vehicleSelect.value);
                        updateTotalWeight();
                    } else {
                        vehicleSelect.value = maxWeight;
                    }
                });
            } else {
                maxWeight = parseInt(vehicleSelect.value);
                updateTotalWeight();
            }
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = async () => {
            const hasPermission = await checkCameraPermissions();
            if (hasPermission) {
                await initializeBarcodeDetector();
            }
            loadDataFromLocalStorage();
        };

        // Ù…Ù†Ø¹ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('beforeunload', (event) => {
            if (shipmentTable.rows.length > 0) {
                event.preventDefault();
                event.returnValue = 'Ù„Ø¯ÙŠÙƒ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
            }
        });

        // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        startScan.addEventListener('click', async () => {
            if (!isScanning) {
                await startCamera();
            } else {
                stopCamera();
            }
        });

        switchCameraBtn.addEventListener('click', switchCamera);
        toggleFlashBtn.addEventListener('click', toggleFlash);
        manualInputBtn.addEventListener('click', manualInput);
        vehicleSelect.addEventListener('change', warnBeforeChangingVehicle);

        saveDataButton.addEventListener('click', () => {
            saveDataButton.disabled = true;
            saveDataButton.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: 'Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    // TODO: Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ API Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª
                    // Ù…Ø«Ø§Ù„:
                    // await fetch('/api/shipments', { method: 'POST', body: JSON.stringify(data) });
                    saveDataToLocalStorage();
                    clearData();
                    Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸!', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
                saveDataButton.disabled = false;
                saveDataButton.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            });
        });
    </script>
</body>
</html>